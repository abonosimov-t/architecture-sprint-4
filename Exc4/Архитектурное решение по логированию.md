# Архитектурное решение по логированию

## 1. Планирование логирование

### Логи уровня INFO
1. Internet Shop
   - Создание заказа: timestamp, order_id, customer_id, total_amount
   - Загрузка 3D-модели: timestamp, order_id, file_name, file_size
   - Изменение статуса: timestamp, order_id, old_status, new_status
   - Оплата заказа: timestamp, order_id, payment_method, payment_status
   
2. Производство (MES):
   - Начало расчета стоимости: timestamp, order_id, model_complexity
   - Завершение расчета: timestamp, order_id, calculation_time, result
   - Запуск производства: timestamp, order_id, production_line
   - Этапы производства: timestamp, order_id, stage, completion_percentage

3. CRM:
   - Назначение менеджера: timestamp, order_id, manager_id
   - Коммуникации с клиентом: timestamp, order_id, communication_type
   - Изменение приоритета: timestamp, order_id, old_priority, new_priority
   - Обновление данных заказа: timestamp, order_id, field_changed, new_value
   
Другие уровни логирования так же необходимы:

1. WARN:
   - Превышение времени ответа API (>1s)
   - Повторные попытки операций
   - Нехватка ресурсов 
   - Проблемы с подключением к внешним сервисам
   - Ошибки валидации данных

2. ERROR:
   - Ошибки расчета стоимости
   - Недоступность критичных сервисов
   - Проблемы с базой данных
   - Ошибки при обработке платежей
   - Потеря сообщений в очередях

3. FATAL:
   - Критические сбои системы
   - Нарушение целостности данных
   - Проблемы с безопасностью
   - Недоступность основных компонентов
   
Для отладки и поиска пробелм стоит использовать логи уровня DEBUG (по умолчанию оключены в продакшене):
   - Детальная отладочная информация
   - Значения переменных
   - Промежуточные результаты расчетов


## 2. Мотивация
Система логирования позволит:
* Отслеживать все важные бизнес-операции
* Быстро находить причины проблем
* Обеспечить аудит действий

Метрики, на которые повлияет логирование:
    - Mean Time To Resolution (MTTR)
    - Доступность сервисов (Availability)
    - Процент потерянных заказов
    - Время обработки заказа
    
Приоритизация внедрения:
1. Internet Shop, т.к.:
   - Точка входа заказов
   - Прямой контакт с клиентами
   - Критичные финансовые операции
2. MES система, т.к.:
   - Критичные расчеты стоимости
   - Управление производством
   - Сложные вычисления

Трейсинг и логирование взимодополняют друг друга. Трейсинг стоит внедрять, когда существует сложное межкомпонентное взаимодйствие, логирование - для отслеживания опреаций внутри компонента.


## 3. Предлагаемое решение
Предлагается реализовать логирование на основе ELK-стека. 

Компоненты:
   - Elasticsearch
   - Logstash
   - Kibana
   - Filebeat на каждом сервере приложений
   
Политика безопасности:
    - Маскировка персональных данных 
    - Сокрытие финансовых данных (например, номеров банковских карт)
    - Ролеая модель доступа к чтению логов
    - Огранизация политики хранения
    
Политика хранения:
    - Hot-хранилище (SSD): период хранения - 7 дней
    - Warm хранилище (HDD): период хранения - 60 дней
    - Cold-хранилище (S3): период хранения 1 год


## 4. Превращения системы сбора логов в систему анализа логов
Внедрение системы анализа логов:
- Настройка алертинга для критических ошибок (500-е ответы, таймауты)
- Визуализация отчетности в Kibana
- Отчетность за периоды
- Выявление аномалий
- Анализ с помощью МL

## 5. Диаграмма C4

[Диаграмма компонентов с внедрённым логированием](./diagram.drawio)
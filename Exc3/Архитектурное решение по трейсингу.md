# Архитектурное решение по трейсингу
## 1. Планирование трейсинга

Проанализируем критические точки в системе, где заказ может "потеряться" или "зависнуть", и определим места для внедрения трейсинга.

### 1. Internet Shop
#### 1. Создание заказа:
   - Загрузка 3D-модели
   - Валидация файла модели
   - Сохранение в базу данных
   - Отправка в MES для расчета
#### 2. Обработка платежа:
   - Создание платежного поручения
   - Подтверждение оплаты
   - Обновление статуса заказа   
### 2. MES
#### 1. Расчет стоимости:
   - Получение 3D-модели
   - Валидация модели
   - Процесс расчета
   - Отправка результата
#### 2. Очередь заказов:
   - Получение заказа из RabbitMQ
   - Обработка заказа оператором
   - Обновление статуса
   - Отправка уведомлений   
### 3. CRM
#### 1. Обработка заказа:
   - Получение заказа из MES
   - Валидация данных
   - Назначение менеджера
   - Обновление статуса
#### 2. Коммуникации:
   - Отправка уведомлений клиенту
   - Получение подтверждений
   - Обновление информации
### 4. RabbitMQ
- Передача между сервисами:
   - Онлайн-магазин → MES
   - MES → CRM
   - CRM → Онлайн-магазин

## 2. Мотивация

Текущие проблемы компании
- Потеря заказов в системе
- Длительные задержки в обработке
- Непрозрачность процесса для клиентов
- Сложность диагностики проблем
- Потеря крупных контрактов из-за проблем с заказами

Что даст трейсинг:
- Визуализация пути заказа через все системы
- Быстрая идентификация проблемных мест
- Измерение времени на каждом этапе
- Отслеживание причинно-следственных связей
- Сокращение времени решения инцидентов
- Повышение удовлетворенности клиентов
- Снижение операционных затрат
- Предотвращение потери заказов

Влияние на бизнес-метрики:
 - Технические 
    - MTTR (среднее время разрешения)
    - Количество потерянных заказов
    - Среднее время обработки заказа
- Бизнес-метрики:
    - Удовлетворенность клиентов
    - Процент успешно выполненных контрактов
    - Операционные расходы на поддержку
    
## 3. Предлагаемое решение
1. Основные компоненты системы трейсинга
- Jaeger Collector для сбора трейсов
- Jaeger UI для визуализации

2. Инструментирование сервисов
    1. Онлайн-магазин (Spring Boot):
        - OpenTelemetry Java SDK

    2. MES (ASP.NET Core):
        - OpenTelemetry .NET SDK

    3. CRM API (Spring Boot):
        - OpenTelemetry Java SDK

    4. RabbitMQ:
        - OpenTelemetry SDK для messaging
        - Propagation контекста через сообщения

## 4. Компромиссы

1. Трейсинг не будет эффективен для компонентов системы, работающих автономно или очень ограниченно взаимодействующих с другими компонентами системы. Например, решить с помощью трейсинга проблему долго расчёта стоимости изделия не получится. 
2. Интеграцию трейсинга возможно произвести внутри контура "Александрита", но не получится включить в неё внешние системы партнёров, обращющихся к API MES. 

В случае компании "Александрит" трейсинг целесообразен, так как:
1. Система распределенная
2. Есть проблемы с отслеживанием заказов
3. Высокая стоимость ошибок
4. Достаточно ресурсов для внедрения
5. Четкая бизнес-потребность

## 5. Безопасность
Меры безопасности системы трейсинга:
- Аутентификация и авторизация
    - Двухфакторная аутентификация, интеграция с корпоративными SSO
    - Ролевая модель доступа
    - Ограничение доступа (Белый список, VPN)
- Защита данных
    - Скрытие финансовой информации
    - Шифрование чувствительных данных
    - Ограничение доступа к полным данным
    - Логирование доступа к критичным данным
    - Автоматическое удаление устаревших данных
- Сетевая безопасность
    - Закрытый доступ к Jager Collector
    - Изолированный сегмент для компонентов трейсинга
    - Контроль доступа на уровне сети
    
    
## 6. Диаграмма C4

[Диаграмма компонентов с внедрённым трейсингом](./diagram.drawio)